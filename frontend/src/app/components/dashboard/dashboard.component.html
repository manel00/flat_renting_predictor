<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>üìä Dashboard de Precios de Vivienda</h1>
        <p class="subtitle">An√°lisis de precios de alquiler en Barcelona</p>
    </div>

    <!-- Filters Panel -->
    <div class="filters-container">
        <button class="filters-toggle" (click)="toggleFilters()">
            <span class="icon">{{ showFilters ? 'üîΩ' : '‚ñ∂Ô∏è' }}</span>
            {{ showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
        </button>

        <div class="filters-panel" *ngIf="showFilters">
            <div class="filter-group">
                <label>üîç Buscar Territorio</label>
                <input type="text" class="search-input" placeholder="Escribe el nombre del territorio..."
                    [(ngModel)]="searchTerm" (input)="applyFilters()">
            </div>

            <div class="filter-group">
                <label>üìç Tipo de Territorio</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" [checked]="selectedTypes.includes('Barri')"
                            (change)="toggleType('Barri')">
                        <span>Barrios</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" [checked]="selectedTypes.includes('Districte')"
                            (change)="toggleType('Districte')">
                        <span>Distritos</span>
                    </label>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn-clear-filters" (click)="clearFilters()">
                    üîÑ Limpiar Filtros
                </button>
                <div class="filter-results">
                    Mostrando: {{ filteredDistricts.length + filteredNeighborhoods.length }} territorios
                </div>
            </div>
        </div>
    </div>

    <div class="loading-container" *ngIf="loading">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <div class="error-container" *ngIf="error">
        <p>{{ error }}</p>
        <button (click)="loadTerritoryComparison()" class="retry-button">Reintentar</button>
    </div>

    <!-- Territory Comparison Charts -->
    <div class="stats-section">
        <h2>Comparaci√≥n: Distritos vs Barrios</h2>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>Distritos (Districte)</h3>
                <div id="districtsChart" class="plotly-chart"></div>
            </div>

            <!-- Model Metrics Section - Below Districts Chart -->
            <div class="model-metrics-section" *ngIf="modelMetrics">
                <h3>üìà Rendimiento del Modelo de Predicci√≥n</h3>
                <div class="metrics-grid">
                    <div class="metric-card primary">
                        <div class="metric-label">R¬≤ Score (Test)</div>
                        <div class="metric-value">{{ (modelMetrics.test_r2 * 100).toFixed(2) }}%</div>
                        <div class="metric-description">Precisi√≥n del modelo: indica qu√© tan bien el modelo predice los
                            precios. 100% = predicci√≥n perfecta.</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">CV R¬≤ Score</div>
                        <div class="metric-value">{{ (modelMetrics.cv_mean * 100).toFixed(2) }}%</div>
                        <div class="metric-description">Validaci√≥n cruzada (5-fold): confirma que el modelo funciona
                            bien con datos nuevos.</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">RMSE</div>
                        <div class="metric-value">{{ modelMetrics.test_rmse.toFixed(2) }}</div>
                        <div class="metric-description">Error cuadr√°tico medio: penaliza m√°s los errores grandes. Valor
                            m√°s bajo = mejor.</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">MAE</div>
                        <div class="metric-value">{{ modelMetrics.test_mae.toFixed(2) }}</div>
                        <div class="metric-description">Error absoluto medio: promedio de la diferencia entre predicci√≥n
                            y valor real.</div>
                    </div>
                </div>
                <div class="model-info">
                    <span class="model-badge">ü§ñ {{ modelMetrics.model_type.toUpperCase() }}</span>
                    <span class="model-note">Modelo entrenado con caracter√≠sticas avanzadas (lag features, rolling
                        averages, growth rates)</span>
                </div>
            </div>

            <div class="chart-container">
                <h3>Barrios (Barri) <span *ngIf="predictionsLoaded" class="predictions-badge">+ Predicciones</span></h3>
                <div class="prediction-controls-inline">
                    <button class="load-predictions-btn" (click)="loadPredictions()" [disabled]="loadingPredictions">
                        <span *ngIf="!loadingPredictions">üîÆ Cargar Predicciones 2026-2030</span>
                        <span *ngIf="loadingPredictions" class="spinner-small"></span>
                        <span *ngIf="loadingPredictions">Generando predicciones...</span>
                    </button>
                </div>
                <div id="neighborhoodsChart" class="plotly-chart"></div>
            </div>
        </div>
    </div>

    <!-- Data Insights Section -->
    <div class="insights-section" *ngIf="insights">
        <h2>üìä An√°lisis de Datos e Inteligencia</h2>

        <!-- Key Metrics Banner -->
        <div class="key-metrics-banner">
            <div class="metric-card-large highlight">
                <div class="metric-icon">üèôÔ∏è</div>
                <div class="metric-content">
                    <div class="metric-label">Barcelona - Precio Actual</div>
                    <div class="metric-value-large">‚Ç¨{{ insights.trends.barcelona_city.current_price_2025.toFixed(2)
                        }}/m¬≤</div>
                    <div class="metric-trend positive">+{{ insights.trends.barcelona_city.growth_5yr_pct }}% (5 a√±os)
                    </div>
                </div>
            </div>
            <div class="metric-card-large">
                <div class="metric-icon">üîÆ</div>
                <div class="metric-content">
                    <div class="metric-label">Predicci√≥n 2026</div>
                    <div class="metric-value-large">‚Ç¨{{
                        insights.predictions_2026.barcelona_2026.predicted_price.toFixed(2) }}/m¬≤</div>
                    <div class="metric-trend positive">+{{ ((insights.predictions_2026.barcelona_2026.predicted_price /
                        insights.trends.barcelona_city.current_price_2025 - 1) * 100).toFixed(2) }}% esperado</div>
                </div>
            </div>
            <div class="metric-card-large">
                <div class="metric-icon">üìà</div>
                <div class="metric-content">
                    <div class="metric-label">Distrito Top</div>
                    <div class="metric-value-medium">{{ insights.trends.top_growing_districts[0].name }}</div>
                    <div class="metric-trend positive">+{{ insights.trends.top_growing_districts[0].growth_5yr_pct }}%
                        crecimiento</div>
                </div>
            </div>
        </div>

        <!-- Investment Opportunities -->
        <div class="insights-grid">
            <div class="insights-panel">
                <h3>üí∞ Top 5 Oportunidades de Inversi√≥n</h3>
                <div class="opportunities-list">
                    <div class="opportunity-card"
                        *ngFor="let opp of insights.investment_opportunities.slice(0, 5); let i = index">
                        <div class="opportunity-rank">{{ i + 1 }}</div>
                        <div class="opportunity-content">
                            <div class="opportunity-name">{{ opp.neighborhood }}</div>
                            <div class="opportunity-stats">
                                <span class="stat-item">
                                    <span class="stat-label">Precio:</span>
                                    <span class="stat-value">‚Ç¨{{ opp.price_2025.toFixed(0) }}/m¬≤</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-label">Crecimiento 5a:</span>
                                    <span class="stat-value positive">+{{ opp.growth_5yr_pct }}%</span>
                                </span>
                            </div>
                            <div class="opportunity-score">
                                <div class="score-bar">
                                    <div class="score-fill" [style.width.%]="(opp.investment_score / 50) * 100"></div>
                                </div>
                                <span class="score-value">Score: {{ opp.investment_score.toFixed(1) }}</span>
                            </div>
                            <div class="opportunity-badge" *ngIf="opp.vs_barcelona_avg < -30">
                                {{ opp.vs_barcelona_avg < 0 ? -opp.vs_barcelona_avg : opp.vs_barcelona_avg |
                                    number:'1.0-0' }}% bajo promedio </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- District Growth Comparison -->
                <div class="insights-panel">
                    <h3>üìä Crecimiento por Distrito (5 a√±os)</h3>
                    <div class="district-growth-list">
                        <div class="district-item" *ngFor="let district of insights.trends.top_growing_districts">
                            <div class="district-name">{{ district.name }}</div>
                            <div class="district-growth-bar">
                                <div class="growth-bar-fill" [style.width.%]="(district.growth_5yr_pct / 25) * 100">
                                </div>
                                <span class="growth-percentage">+{{ district.growth_5yr_pct }}%</span>
                            </div>
                            <div class="district-price">‚Ç¨{{ district.price_2025.toFixed(0) }}/m¬≤</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2026 Predictions -->
            <div class="predictions-panel">
                <h3>üîÆ Predicciones 2026 - Top Distritos</h3>
                <div class="predictions-grid">
                    <div class="prediction-card"
                        *ngFor="let pred of insights.predictions_2026.districts_2026.slice(0, 6)">
                        <div class="prediction-district">{{ pred.district }}</div>
                        <div class="prediction-values">
                            <div class="prediction-row">
                                <span class="prediction-label">2025:</span>
                                <span class="prediction-value">‚Ç¨{{ pred.price_2025.toFixed(0) }}</span>
                            </div>
                            <div class="prediction-arrow">‚Üí</div>
                            <div class="prediction-row">
                                <span class="prediction-label">2026:</span>
                                <span class="prediction-value highlight">‚Ç¨{{ pred.predicted_2026.toFixed(0) }}</span>
                            </div>
                        </div>
                        <div class="prediction-growth" [class.high-growth]="pred.expected_growth_pct > 8">
                            +{{ pred.expected_growth_pct }}%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Findings -->
            <div class="key-findings-panel">
                <h3>üéØ Hallazgos Clave</h3>
                <ul class="findings-list">
                    <li *ngFor="let finding of insights.key_findings">{{ finding }}</li>
                </ul>
            </div>
        </div>
    </div>